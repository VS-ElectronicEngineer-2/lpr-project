<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPR Dashboard</title>
    <style>
        /* üîπ Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
        }

        /* üîπ Sidebar Styling */
        .sidebar {
            width: 250px;
            background: #1a1a2e;
            color: white;
            padding: 20px 0;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
        }

        .sidebar ul li {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 10px;
            transition: background 0.2s ease-in-out;
        }

        .sidebar ul li:hover {
            background: #0a3d62;
        }

        /* üîπ Content Layout */
        .content {
            flex: 1;
            padding: 80px 20px 20px 270px;
        }

        /* üîπ Top Bar */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: white;
            width: calc(100% - 250px);
            position: fixed;
            left: 250px;
            top: 0;
            height: 60px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .topbar h1 {
            font-size: 18px;
            font-weight: bold;
            color: #031d67;
        }

        /* üîπ Section Layout */
        .section {
            display: none;
        }

        .active {
            display: block;
        }

        /* üîπ Profile Container */
        .profile-container {
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        /* üîπ Profile Icon */
        .profile-icon {
            width: 40px;
            height: 40px;
            background: #031d67;
            color: white;
            font-size: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
        }

        /* üîπ Dropdown Menu */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            width: 200px;
            padding: 10px 0;
            z-index: 1000;
        }

        /* üîπ Dropdown Items */
        .dropdown-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            text-decoration: none;
            color: black;
            font-size: 14px;
        }

        /* üîπ Hover Effect */
        .dropdown-menu a:hover {
            background: #f4f4f4;
        }

        /* üîπ Icons Alignment */
        .dropdown-menu a i {
            margin-right: 10px;
        }

        /* üîπ Live Stream & Tables Container */
        .live-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            margin-top: 20px;
        }

        .live-video-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            /* Take full width */
        }

        .live-video {
            width: 100%;
            max-width: 1200px;
            /* Increase the max width */
            height: 600px;
            /* Increase height */
            object-fit: cover;
            /* Ensures the aspect ratio is maintained */
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* Increase the gap between live stream and table */
        .live-container {
            display: flex;
            gap: 50px;
            /* More space between video and detected plates table */
            align-items: flex-start;
            margin-top: 20px;
        }

        /* Adjust table container so it doesn‚Äôt take too much space */
        .dashboard-card {
            width: 600px;
            /* Set fixed width for the detected plates table */
        }

        /* üîπ Start & Stop Buttons */
        .button-container {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
        }

        .start-btn {
            background: green;
            color: white;
        }

        .stop-btn {
            background: red;
            color: white;
        }

        /* üîπ Right Section: Table */
        .dashboard-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        /* üîπ Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        table,
        th,
        td {
            border: 1px solid black;
        }

        th,
        td {
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #031d67;
            color: white;
        }

        /* ‚úÖ Ensure the map is visible and properly sized */
        #map {
            height: 500px;
            /* Adjust as needed */
            width: 100%;
            /* Ensures full width */
            min-width: 500px;
            /* Prevents it from shrinking */
            max-width: 1200px;
            /* Limits maximum width */
            margin: auto;
            /* Centers the map */
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            display: block;
            /* Ensure it's visible */
        }
    </style>

    <!-- üîπ Leaflet.js (for the Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <head>
        ...
        <!-- ‚úÖ Load jsPDF -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

        <!-- ‚úÖ Load autoTable plugin -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    </head>

</head>

<body>

    <!-- üîπ Sidebar -->
    <div class="sidebar">
        <ul>
            <li onclick="showSection('dashboard')"><i>üè†</i> <span>Dashboard</span></li>
            <li onclick="showSection('livestream')"><i>üì°</i> <span>Live Stream</span></li>
            <li onclick="showSection('dispatch-map')"><i>üó∫</i> <span>Dispatch Map</span></li>
            <li onclick="showSection('tracking')"><i>üìç</i> <span>Tracking</span></li>
        </ul>
    </div>

    <!-- üîπ Top Bar -->
    <div class="topbar">
        <h1>License Plate Recognition Dashboard</h1>

        <!-- üîπ Profile & Logout Dropdown (Move Inside Top Bar) -->
        <div class="profile-container" onclick="toggleDropdown()">
            <span class="profile-icon">HM</span>
            <div id="dropdown-menu" class="dropdown-menu">
                <a href="#"><i>‚öôÔ∏è</i> Account Settings</a>
                <a href="/logout"><i>üö™</i> Logout</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content">

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <h2>Dashboard</h2>
            <div class="dashboard-card">
                <h3>Detected Plates & Summons Queue</h3>
                <table>
                    <thead>
                        <tr>
                            <th>License Plate</th>
                            <th>Status</th>
                            <th>Time</th>
                            <th>Notice No</th>
                            <th>Offence</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="dashboardTable"></tbody>
                </table>
            </div>
        </div>

        <!-- ‚úÖ Dispatch Map Section (Map should be separate and inside this section) -->
        <div id="dispatch-map" class="section">
            <h2>Dispatch Map</h2>
            <div id="map"></div> <!-- üîπ Map div should be here -->
        </div>

        <!-- Live Stream Section -->
        <div id="livestream" class="section">
            <h2>Live Stream</h2>

            <div class="live-container">
                <!-- ‚úÖ Left Section: Live Stream Video -->
                <div class="live-video-container">
                    <img id="liveStreamVideo" src="/video_feed" class="live-video" alt="Live Stream">

                    <!-- ‚úÖ Start & Stop Buttons BELOW the live stream -->
                    <div class="button-container">
                        <button class="btn start-btn" onclick="startLiveStream()">Start</button>
                        <button class="btn stop-btn" onclick="stopLiveStream()">Stop</button>
                    </div>
                </div>

                <!-- ‚úÖ Right Section: Detected Plates Table -->
                <div class="dashboard-card">
                    <h3>Detected Plates & Summons Queue (Live)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th> <!-- New column for queue number -->
                                <th>License Plate</th>
                                <th>Status</th>
                                <th>Time</th>
                                <th>Total Summons</th> <!-- New column for Scofflaw Summons No -->
                                <th>Action</th> <!-- New column for Download Button -->
                            </tr>
                        </thead>
                        <tbody id="livestreamTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- üîπ JavaScript -->
            <script>
                function showSection(sectionId) {
                    document.querySelectorAll('.section').forEach(section => {
                        section.classList.toggle('active', section.id === sectionId);
                    });

                    if (sectionId === 'dashboard') {
                        fetchDashboardData();
                    }

                    if (sectionId === 'dispatch-map') {
                        setTimeout(() => {
                            initializeMap();  // üîπ Initialize the map once
                            updateMap();  // üîπ Ensure it resizes properly
                        }, 300); // üîπ Small delay ensures the section is visible before updating the map
                    }
                }

                let map; // Declare the map variable globally

                // üîπ STEP 2: Initialize the Map Only Once
                function initializeMap() {
                    if (!map) { // üîπ Prevents multiple map creations
                        map = L.map('map').setView([3.1390, 101.6869], 12);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap contributors'
                        }).addTo(map);
                    }
                }

                // üîπ STEP 3: Ensure the Map Updates When Displayed
                function updateMap() {
                    setTimeout(() => {
                        if (map) {
                            map.invalidateSize(); // üîπ Fixes the map alignment issue
                        }
                    }, 500); // üîπ Short delay to ensure it loads before resizing
                }

                let plateMarkers = {}; // Store markers to avoid duplicatio

                function toggleDropdown() {
                    var menu = document.getElementById("dropdown-menu");
                    menu.style.display = (menu.style.display === "block") ? "none" : "block";
                }

                // Close dropdown when clicking outside
                window.onclick = function (event) {
                    if (!event.target.closest('.profile-container')) {
                        document.getElementById("dropdown-menu").style.display = "none";
                    }
                }

                function updateMap() {
                    fetch("/plates")  // Fetch detected plates from API
                        .then(response => response.json())
                        .then(detectedPlates => {
                            return fetch("/summons")
                                .then(response => response.json())
                                .then(summonsData => {
                                    console.log("üìå Detected Plates:", detectedPlates);
                                    console.log("üìå Summons Data:", summonsData);

                                    // Remove old markers
                                    Object.values(plateMarkers).forEach(marker => map.removeLayer(marker));
                                    plateMarkers = {}; // Clear markers

                                    detectedPlates.forEach(plate => {
                                        const { plate: plateNo, latitude, longitude, status, snapshot, time, officer_id } = plate;

                                        if (!latitude || !longitude) {
                                            console.warn(`üö® Skipping plate ${plateNo}: No GPS Data`);
                                            return;
                                        }

                                        // ‚úÖ Check if this plate has an outstanding summons
                                        let isScofflaw = summonsData.some(summon => summon.plate === plateNo);

                                        // ‚úÖ Set the correct colors
                                        let borderColor, markerColor;
                                        let lowerCaseStatus = status.toLowerCase().trim(); // Normalize case & remove spaces

                                        // ‚úÖ Prioritize Scofflaw FIRST
                                        if (isScofflaw) {
                                            borderColor = "blue";  // üîµ Scofflaw
                                            markerColor = "blue";
                                        } else if (lowerCaseStatus === "paid" || lowerCaseStatus.startsWith("paid ")) {
                                            borderColor = "green";  // üü¢ Paid
                                            markerColor = "green";
                                        } else if (lowerCaseStatus === "not paid" || lowerCaseStatus.startsWith("not paid ")) {
                                            borderColor = "red";  // üî¥ Not Paid
                                            markerColor = "red";
                                        } else {
                                            borderColor = "gray";  // ‚ö™ Default unknown status
                                            markerColor = "gray";
                                        }

                                        // ‚úÖ Debugging log
                                        console.log(`üöó Plate: ${plateNo} | Status: ${status} | Scofflaw: ${isScofflaw} | Assigned Color: ${borderColor}`);

                                        // ‚úÖ Custom marker icon with dynamic color
                                        let customIcon = L.divIcon({
                                            className: "custom-marker",
                                            html: `<div style="background-color:${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                                            iconSize: [20, 20]
                                        });

                                        // ‚úÖ Add marker with proper color
                                        let marker = L.marker([latitude, longitude], { icon: customIcon }).addTo(map);
                                        plateMarkers[plateNo] = marker;

                                        // ‚úÖ Full background color for popup
                                        let popupContent = `
                            <div style="width:250px; background-color:${borderColor}; color:white; border-radius: 10px; padding: 10px;">
                                <strong>Plate:</strong> ${plateNo}<br>
                                <strong>Status:</strong> ${isScofflaw ? "Scofflaw" : status}<br>
                                <strong>Time:</strong> ${time}<br>
                                <strong>Officer ID:</strong> ${officer_id}<br>
                                <img src="${snapshot}" style="width:100%; margin-top:5px; border-radius:5px;">
                            </div>
                        `;

                                        // ‚úÖ Bind popup to marker
                                        marker.bindPopup(popupContent);
                                    });
                                });
                        })
                        .catch(error => console.error("‚ùå Error fetching plates:", error));
                }


                function startLiveStream() {
                    document.getElementById("liveStreamVideo").src = "/video_feed";
                }

                function stopLiveStream() {
                    document.getElementById("liveStreamVideo").src = "";
                }

                function fetchData() {
                    fetch("/plates")
                        .then(response => response.json())
                        .then(detectedData => {
                            fetch("/summons")
                                .then(response => response.json())
                                .then(summonsData => {
                                    let livestreamTable = document.getElementById("livestreamTable");
                                    livestreamTable.innerHTML = ""; // Clear previous data

                                    let allPlates = []; // Store plates with queue numbers

                                    // Combine detected plates and summons
                                    detectedData.forEach(plate => {
                                        allPlates.push({
                                            plate: plate.plate,
                                            status: plate.status,
                                            time: plate.time,
                                            isScofflaw: false,
                                            summonsNo: "" // Default empty
                                        });
                                    });

                                    // Mark summons plates and assign queue numbers
                                    let scofflawQueue = 1; // Start summons queue at 1
                                    summonsData.forEach(summon => {
                                        let existing = allPlates.find(p => p.plate === summon.plate);
                                        if (existing) {
                                            existing.status = "Scofflaw";
                                            existing.isScofflaw = true;
                                            existing.summonsNo = `${scofflawQueue}`; // Assign queue number
                                            scofflawQueue++;
                                        } else {
                                            allPlates.push({
                                                plate: summon.plate,
                                                status: "Scofflaw",
                                                time: "N/A",
                                                isScofflaw: true,
                                                summonsNo: `${scofflawQueue}`
                                            });
                                            scofflawQueue++;
                                        }
                                    });

                                    // Display with queue numbers
                                    allPlates.forEach((entry, index) => {
                                        let statusColor = entry.status.includes("Not Paid") ? "red" :
                                            entry.status.includes("Paid") ? "green" :
                                                "blue";  // Default blue for scofflaw

                                        let summonsColumn = entry.isScofflaw ? entry.summonsNo : "-"; // Show queue number for scofflaw only

                                        let actionButton = entry.isScofflaw
                                            ? `<button onclick="generatePDF('${entry.plate}')" 
                                       style="background: blue; color: white; border: none; padding: 5px; cursor: pointer;">
                                       Download PDF
                                </button>`
                                            : "-";

                                        let rowHTML = `
                        <tr>
                            <td>${index + 1}</td> <!-- Row Number -->
                            <td style="color:${statusColor}; font-weight:bold;">${entry.plate}</td>
                            <td style="color:${statusColor}; font-weight:bold;">${entry.status}</td>
                            <td style="color:${statusColor}; font-weight:bold;">${entry.time}</td>
                            <td>${summonsColumn}</td> <!-- Show summons number for Scofflaw -->
                            <td>${actionButton}</td>
                        </tr>`;

                                        livestreamTable.innerHTML += rowHTML;
                                    });
                                });
                        });
                }

                function fetchDashboardData() {
                    fetch("/plates")
                        .then(response => response.json())
                        .then(detectedData => {
                            fetch("/summons")
                                .then(response => response.json())
                                .then(summonsData => {
                                    let combinedTable = document.getElementById("dashboardTable");
                                    combinedTable.innerHTML = "";

                                    detectedData.forEach(plate => {
                                        let matchingSummons = summonsData.filter(s => s.plate === plate.plate);
                                        let statusText = plate.status;
                                        let statusColor = statusText.includes("Not Paid") ? "red" : "green";
                                        if (matchingSummons.length > 0) {
                                            statusText = "Scofflaw";
                                            statusColor = "blue";
                                        }

                                        combinedTable.innerHTML += `
                                    <tr>
                                        <td style="color:${statusColor}; font-weight:bold;">${plate.plate}</td>
                                        <td style="color:${statusColor}; font-weight:bold;">${statusText}</td>
                                        <td style="color:${statusColor}; font-weight:bold;">${plate.time}</td>
                                        <td>${matchingSummons.map(s => s.noticeNo).join(", ") || "N/A"}</td>
                                        <td>${matchingSummons.map(s => s.offence).join(" | ") || "No Offence"}</td>
                                        <td>${matchingSummons.map(s => s.amount).join(", ") || "N/A"}</td>
                                    </tr>
                                `;
                                    });
                                });
                        });
                }

                function generatePDF(plateNumber) {
                    if (!window.jspdf) {
                        alert("Error: jsPDF is not loaded. Please check the script import.");
                        return;
                    }

                    fetch(`/summons?plate=${plateNumber}`)
                        .then(response => response.json())
                        .then(summonsData => {
                            if (summonsData.length === 0) {
                                alert("No summons found for this plate.");
                                return;
                            }

                            const { jsPDF } = window.jspdf;
                            const doc = new jsPDF();

                            if (!doc.autoTable) {
                                alert("Error: jsPDF autoTable plugin is missing.");
                                return;
                            }

                            // ‚úÖ Title Formatting
                            doc.setFontSize(16);
                            doc.setFont("helvetica", "bold");
                            doc.text("NOTIS TERTUNGGAK", 105, 20, { align: "center" });
                            doc.text("KESALAHAN DI BAWAH", 105, 30, { align: "center" });
                            doc.text("AKTA PENGANGKUTAN JALAN 1987", 105, 40, { align: "center" });

                            // ‚úÖ Document Metadata
                            doc.setFontSize(12);
                            doc.setFont("helvetica", "normal");
                            let startY = 50;
                            doc.text(`Tarikh Cetak     : ${new Date().toISOString().split('T')[0]}`, 15, startY);
                            doc.text(`No Rujukan       : -`, 15, startY + 6);
                            doc.text(`No Pendaftaran Kenderaan : ${plateNumber}`, 15, startY + 12);
                            doc.text(`Nama Pemilik Berdaftar  : -`, 15, startY + 18);
                            doc.text(`ID Pemilik       : -`, 15, startY + 24);
                            doc.text(`Address          : -`, 15, startY + 30);

                            // ‚úÖ Add Explanation Text
                            let tableY = startY + 40;
                            doc.setFontSize(10);
                            doc.text("Berhubung dengan notis saman bernombor, BAHWASANYA anda telah melakukan kesalahan berikut:", 15, tableY);

                            tableY += 10;

                            // ‚úÖ Extract "Perintah X (Y)" from the Offence Text
                            function extractPerintah(offenceText) {
                                // Try to find "PERINTAH X (Y)"
                                let match = offenceText.match(/PERINTAH\s\d+\s*\(\d+\)/i);
                                if (match) {
                                    return match[0];  // Return "Perintah X (Y)" if found
                                }

                                // If no "PERINTAH" is found, check for alternative formats
                                let matchAlt = offenceText.match(/\bPERINTAH\s\d+/i);
                                if (matchAlt) {
                                    return matchAlt[0]; // Return "Perintah X" if found
                                }

                                // Default: Return full text if nothing matches
                                return offenceText;
                            }

                            // ‚úÖ Use autoTable for proper alignment
                            doc.autoTable({
                                startY: tableY,
                                head: [["Bil", "Tarikh", "Rujukan Kompaun", "Kesalahan", "Lokasi", "Jumlah (RM)"]],
                                body: summonsData.map((summon, index) => [
                                    index + 1,
                                    summon.date || "-",
                                    summon.noticeNo || "-",
                                    extractPerintah(summon.offence), // Extract only "Perintah X (Y)"
                                    summon.location || "-",
                                    `RM${summon.amount || "0.00"}`
                                ]),
                                styles: { fontSize: 10 },
                                headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255] },
                                columnStyles: {
                                    0: { cellWidth: 10 },
                                    1: { cellWidth: 25 },
                                    2: { cellWidth: 40 },
                                    3: { cellWidth: 35 }, // Adjusted for shorter text
                                    4: { cellWidth: 50 },
                                    5: { cellWidth: 25, halign: "right" }
                                },
                                theme: "grid"
                            });

                            // ‚úÖ Calculate total amount
                            let totalAmount = summonsData.reduce((sum, summon) => sum + parseFloat(summon.amount || 0), 0);
                            let finalY = doc.lastAutoTable.finalY + 10;
                            doc.text(`Jumlah Keseluruhan: RM${totalAmount.toFixed(2)}`, 145, finalY);

                            // ‚úÖ Add Final Notice
                            finalY += 15;
                            doc.text("Tuan/Puan dikehendaki menyelesaikan segala tunggakan di atas dalam tempoh 14 hari dari notis ini dikeluarkan.", 15, finalY);
                            doc.text("Sekiranya gagal berbuat demikian, tindakan undang-undang akan diambil.", 15, finalY + 6);

                            // ‚úÖ Footer Section
                            finalY += 18;
                            doc.text("Sekian, terima kasih.", 15, finalY);
                            doc.text("..............................................", 15, finalY + 12);
                            doc.text("Warden Lalu Lintas", 15, finalY + 18);
                            doc.text("No Anggota:", 15, finalY + 24);
                            doc.text("Dewan Bandaraya Kuala Lumpur", 15, finalY + 30);

                            // ‚úÖ Save the PDF
                            doc.save(`${plateNumber}_Summons.pdf`);
                        })
                        .catch(error => console.error("‚ùå Error fetching summons data:", error));
                }



                // üîÑ Refresh data every 5 seconds
                setInterval(fetchData, 5000);
                fetchData();


            </script>

</body>

</html>